<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>砖拽 砖砖转 住转 - 转 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* General styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Vertical layout */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f4f8; /* Light blue-gray background */
            overflow-x: hidden; /* Prevent horizontal scroll */
            padding: 1rem; /* Add some padding for smaller screens */
        }
        /* Container for cups and gift */
        .cup-container {
            position: relative;
            width: 90%; /* Flexible width */
            max-width: 380px; /* Slightly smaller max width */
            height: 130px; /* Adjusted height */
            display: flex;
            justify-content: space-around; /* Distribute cups */
            align-items: flex-end; /* Align cups to the bottom */
            margin-bottom: 2rem;
        }
        /* Cup styling */
        .cup {
            /* Slightly smaller cups for mobile */
            width: 70px;
            height: 90px;
            background-color: #ef4444; /* Red */
            border-radius: 8px 8px 0 0; /* Adjusted rounded top corners */
            position: absolute; /* For positioning and animation */
            bottom: 0;
            cursor: default; /* Cursor changes when guessing is allowed */
            /* Transitions: lifting (bottom), positioning (left, transform) */
            transition: bottom 0.4s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem; /* Adjusted font size */
            color: white;
            /* Prevent text selection on cups */
            user-select: none;
        }
        /* Lifted state for a cup */
        .cup.lifted {
            bottom: 60px; /* Adjusted lift height */
        }
        /* Gift styling */
        .gift {
            width: 45px; /* Adjusted size */
            height: 45px;
            font-size: 2.2rem; /* Adjusted size */
            line-height: 45px;
            text-align: center;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.3s ease-in-out, transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            display: none; /* Hidden initially */
            user-select: none;
            opacity: 0; /* Start fully transparent */
        }
        .gift.visible { /* Class to make gift visible */
             display: flex;
             opacity: 1;
        }
        /* Button styling (main button) */
        #startButton {
            padding: 0.75rem 1.5rem; /* Good tap target size */
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background-color: #2563eb; /* Blue */
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #startButton:hover:not(:disabled) {
            background-color: #1d4ed8; /* Darker blue on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        #startButton:active:not(:disabled) {
            transform: scale(0.98); /* Slight shrink on click */
        }
        #startButton:disabled {
            background-color: #9ca3af; /* Gray when disabled */
            cursor: not-allowed;
            opacity: 0.7;
        }
        /* Message area styling */
        #message {
            min-height: 4rem;
            font-weight: 500;
            color: #1f2937; /* Dark gray text */
            margin-top: 1rem;
            text-align: center;
            width: 90%;
            max-width: 400px;
            line-height: 1.5;
        }
        /* Splat overlay styling */
        #splat-overlay {
            position: fixed; /* Cover the whole screen */
            inset: 0; /* top, right, bottom, left = 0 */
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            font-size: 20vw; /* Slightly larger emoji size relative to viewport width */
            color: red;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Allow clicks through when hidden */
            display: none; /* Start hidden */
        }
        #splat-overlay.visible {
            opacity: 1;
            pointer-events: auto; /* Block clicks when visible */
            display: flex; /* Show when visible */
        }
        /* Joke feedback buttons container */
        #joke-feedback {
            margin-top: 1rem;
            display: flex; /* Use flex for button layout */
            gap: 1rem; /* Space between buttons */
            justify-content: center; /* Center buttons */
            display: none; /* Start hidden */
        }
         /* Joke feedback button styling */
        .feedback-button {
            padding: 0.6rem 1.1rem; /* Slightly larger padding for touch */
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            border: 1px solid transparent;
        }
        #funny-button {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            border-color: #059669; /* Emerald 600 */
        }
        #funny-button:hover {
            background-color: #059669; /* Emerald 600 */
        }
        #not-funny-button {
            background-color: #f87171; /* Red 400 */
            color: white;
            border-color: #ef4444; /* Red 500 */
        }
        #not-funny-button:hover {
            background-color: #ef4444; /* Red 500 */
        }
        .feedback-button:active {
             transform: scale(0.96);
        }

    </style>
</head>
<body class="bg-gray-100 flex flex-col justify-center items-center min-h-screen">

    <h1 class="text-2xl sm:text-3xl font-bold mb-6 text-gray-800 text-center">砖拽 砖砖转 住转</h1>

    <div id="game-area" class="flex flex-col items-center w-full px-2 sm:px-4">
        <div class="cup-container mb-6">
            <div id="cup1" class="cup"></div>
            <div id="cup2" class="cup"></div>
            <div id="cup3" class="cup"></div>
            <div id="gift" class="gift"></div>
        </div>

        <div class="text-center w-full">
            <button id="startButton" class="mb-4">
                砖拽
            </button>
            <p id="message" class="text-base sm:text-lg text-gray-700"></p>

            <div id="joke-feedback">
                <button id="funny-button" class="feedback-button">爪拽 </button>
                <button id="not-funny-button" class="feedback-button"> 爪拽 </button>
            </div>
        </div>
    </div>

    <div id="splat-overlay"></div>

    <script>
        // --- Element References ---
        const cups = Array.from(document.querySelectorAll('.cup'));
        const gift = document.getElementById('gift');
        const startButton = document.getElementById('startButton');
        const message = document.getElementById('message');
        const cupContainer = document.querySelector('.cup-container');
        const splatOverlay = document.getElementById('splat-overlay');
        const jokeFeedbackContainer = document.getElementById('joke-feedback');
        const funnyButton = document.getElementById('funny-button');
        const notFunnyButton = document.getElementById('not-funny-button');

        // --- Game State Variables ---
        let giftHolderElement = null; // The cup element hiding the gift
        let shuffling = false;        // Is the shuffle animation running?
        let canGuess = false;         // Is the player allowed to guess?
        let activeTimeoutId = null;   // Store ID of the current game timeout

        // --- Game Settings ---
        const revealTime = 1000;      // How long the gift is shown initially (ms)
        const liftTime = 400;         // Duration of cup lift animation (ms)
        const shuffleSwapTime = 300;  // Duration of a single cup swap (ms)
        const shuffleDuration = 3000; // Total duration of shuffling (ms)
        const swapsPerShuffle = Math.floor(shuffleDuration / (shuffleSwapTime + 50)); // Number of swaps
        const splatDuration = 1500;   // How long the splat effect stays (ms)

        // --- Fixed positions for each cup slot ---
        // Adjusted percentages for better spacing on mobile
        const cupSlots = [
            { left: '10%', transform: 'translateX(0%)' },      // Left slot
            { left: '50%', transform: 'translateX(-50%)' },   // Middle slot
            { left: '90%', transform: 'translateX(-100%)' }   // Right slot
        ];

        // --- Jokes Array ---
        const jokes = [
            "    砖拽 专住?   驻 专砖转!", " 拽专 砖 砖注 砖注? .", "   驻 拽专专?  驻砖专 住 驻 拽专专.", "  专 专驻 砖?     住.", " 专 砖专 砖 爪 专? '注爪转 砖!'",
            " 拽专 专 砖 专? 拽.", " 砖转祝 住专 ? 砖 驻砖 住驻住.", " 转专  爪 转 砖 驻注?   砖  驻.", " 专  砖? 砖 专,  专拽 砖.", " 拽专 砖    专 砖驻 专? 专拽住.",
            " 转  专?   爪专转.", " 注砖 驻专 注 注抓?  砖 专.", " 驻 爪注 转 爪驻专 砖 ?  砖 转 注专转 转转.", " 拽专  砖 拽住? 专拽专专.", " 专 拽专 拽专 砖? 驻砖 驻.",
            " 专 转驻专转?   专爪 爪转 砖.", " 拽专 转砖 砖住 注? 注拽爪转 注.", " 注砖 砖 注 注抓? 砖.", "  拽转 住专 ?   转 砖注转 砖.", " 拽专 砖砖 砖 转砖?  砖.",
            " 拽专 砖 砖砖  砖 拽  转专 注? 专转.", " 专  转专 砖砖?   爪 .", " 注砖 注专  转 砖驻? 转注.", " 拽专  转 砖 ? 专.", " 住驻专   住驻专 住转?   转 .",
            " 专 住专 驻砖?  转 转,  专 转拽注.", " 拽专   注? .", "  注驻专 转 住驻专?  转.", " 砖转 住驻专 砖 注爪? 抓 抓.", " 拽专 砖 砖 住? 住转.",
            " 转驻  专驻?   专砖 专拽.", " 注砖 驻 转 专住? 砖专.", " 拽专 砖 砖驻 拽 注砖专转 砖专? 专 .", " 砖  专驻?    专住.", " 专  专 砖? 专 拽拽住!",
            " 拽专  砖 转拽? 砖.", " 转   专抓?  砖  专拽 专 转.", " 注砖 注砖 砖? 砖 专砖转.", " 拽专 砖 砖专 拽专? 拽驻.", "  注 转 住驻专?    专转 砖.",
            " 专 注 专砖? 转 转砖专 ,  爪.", " 拽专 转 砖 拽? 爪拽.", "  ?   注砖 '  '.", " 注砖 砖注 拽专 砖 专注?  .", " 拽专 砖 砖砖拽 砖  ? 砖注.",
            "  转  转? 驻砖 注专 砖.", " 专 驻住 砖? 专 驻!", " 拽专   驻?  专.", " 注 ?   专转 转 住 专拽转 转驻砖.", " 注砖 驻专 砖 专 专 专驻? 转注驻转.",
            " 拽专 砖 砖砖转 拽  ? 转住住.", "   专住?  砖驻专 转  砖.", " 专 砖 ?  转注 ,  .", " 拽专 转拽 砖 专? 爪注爪注.", "  住抓' ?   专爪 砖转祝.",
            " 注砖 爪 转转 ? 爪.", " 拽专 砖 砖转 专? 砖注.", "  住 转 拽驻?   专爪 专砖 .", " 专  专爪驻?  注祝 注.", " 拽专 专驻 砖 砖 专拽? 抓.",
            "   ? 驻砖 转 驻驻.", " 注砖 注 爪 驻住? 转驻专专转.", " 拽专 砖 砖 砖专? 砖专.", "  专  专 注?  注 转转转.", " 专 注驻专 拽? 转 转 拽  转 注转.",
            " 拽专 驻专 砖转 ? 专.", "  专 住?   专爪 转 转 砖.", " 注砖 转驻  拽专? 转注专专.", " 拽专 砖 砖驻 专 ? 拽驻抓.", "   拽?  驻转 砖 转.",
            " 专  爪?  转专抓,   爪 注拽.", " 拽专 砖驻 砖住 注  砖专? 驻转.", "  住 住驻专?   专爪 砖转 专.", " 注砖 砖 住驻专? 住驻专转.", " 拽专 砖 砖专 注 专拽转? 砖注.",
            "  专 转?  转 .", " 专  ?  转砖 转专 ,  .", " 拽专    注? 驻.", "   ? 驻砖 转 祝.", " 注砖 砖拽 专 砖专? 注.",
            " 拽专 砖 砖拽专 砖转? 拽住.", "   专驻?    专砖 拽.", " 专 住驻专 祝? 转拽 转,  驻.", " 拽专 专 专驻 砖转 ? 专 专注.", "  注专 ? 驻砖  专转.",
            " 注砖  砖 注爪? 住.", " 拽专 砖 砖专拽 注 ? 住专.", "  爪 砖?  驻 转.", " 专 注抓 ?  转驻住 注,  .", " 拽专 转 砖砖  GPS? 转 拽.",
            "  专 ?   专爪转 专 转 .", " 注砖 专 拽转? 砖专.", " 拽专 砖 砖砖转 专拽 ? 专.", "  驻驻 砖拽?    专祝 注 拽转.", " 专 住专 ? 转  砖转祝.",
            " 拽专 专 ?  注转.", "  砖 专驻?   专砖 砖专 注.", " 注砖 住  砖 砖注? 驻拽.", " 拽专 砖 砖砖  专 注? 住专.", "  专  驻? 驻砖 专.",
            " 专  住驻?  转注砖 .", " 拽专  砖注 注砖转 拽住? 专 驻专."
        ];

        // --- Game Functions ---

        /** Clears any active game timeouts */
        function clearActiveTimeout() {
            if (activeTimeoutId) {
                clearTimeout(activeTimeoutId);
                activeTimeoutId = null;
            }
        }

        /** Resets the cup positions and visual states */
        function resetCupPositions() {
            cups.forEach((cupEl, index) => {
                // Apply position styles from cupSlots
                Object.assign(cupEl.style, cupSlots[index]);
                // Remove visual state classes
                cupEl.classList.remove('lifted', 'shuffling');
                // Store the slot index in a data attribute
                cupEl.dataset.slot = index;
            });
            // Hide the gift visually and structurally
            gift.classList.remove('visible');
            gift.style.display = 'none';
            // Hide the splat overlay
            splatOverlay.classList.remove('visible');
            splatOverlay.style.display = 'none';
            // Hide joke feedback buttons
            jokeFeedbackContainer.style.display = 'none';
        }

        /** Sets up a new round of the game */
        function setupNewRound() {
            console.log("Setting up new round...");
            clearActiveTimeout(); // Clear any leftover timeouts
            message.textContent = '转...'; // Initial message
            canGuess = false;     // Disable guessing
            shuffling = false;    // Not shuffling yet
            startButton.disabled = true; // Disable start button during setup/play
            removeGuessListeners(); // Remove old listeners
            resetCupPositions();    // Put cups back in starting positions

            // Randomly choose which cup hides the gift
            const giftCupIndex = Math.floor(Math.random() * cups.length);
            giftHolderElement = cups[giftCupIndex]; // Store the winning cup element
            console.log(`Gift is under cup in slot: ${giftCupIndex}`); // Log for debugging

            // Position the gift element visually under the winning cup's slot
            const winningSlot = cupSlots[giftCupIndex];
            Object.assign(gift.style, winningSlot); // Match gift position to cup slot

            // Reveal phase: Lift the winning cup and show the gift
            giftHolderElement.classList.add('lifted'); // Lift the cup
            gift.style.display = 'flex'; // Make gift take up space

            // Use a tiny timeout to ensure 'display: flex' applies before opacity transition starts
            setTimeout(() => {
                 gift.classList.add('visible'); // Fade in the gift
            }, 10); // Small delay (10ms)

            // Set timeout to hide the gift and start shuffling after revealTime
            activeTimeoutId = setTimeout(() => {
                giftHolderElement.classList.remove('lifted'); // Lower the cup
                gift.classList.remove('visible'); // Fade out the gift

                // Wait for lift/fade animations to finish before hiding gift and starting shuffle
                activeTimeoutId = setTimeout(() => {
                    gift.style.display = 'none'; // Hide gift element completely
                    startShuffle(); // Begin shuffling sequence
                }, Math.max(liftTime, 300)); // Wait for the longer of lift or fade transition

            }, revealTime); // Duration of the reveal phase
        }

        /** Starts the cup shuffling animation */
        function startShuffle() {
            console.log("Starting shuffle...");
            message.textContent = '...注专'; // Update status message
            shuffling = true;           // Set shuffling state
            clearActiveTimeout();       // Clear previous timeouts

            let shuffleCount = 0; // Counter for number of swaps
            const shuffleInterval = shuffleSwapTime + 50; // Time between swaps (swap time + small buffer)

            // Function to perform one step of the shuffle
            function performShuffleStep() {
                // Double-check if shuffling was cancelled externally
                if (!shuffling) {
                    console.log("Shuffle cancelled during steps.");
                    return; // Stop if shuffling flag is false
                }
                // Check if required number of swaps is complete
                if (shuffleCount >= swapsPerShuffle) {
                    endShuffle(); // Finish shuffling
                    return;
                }
                shuffleSinglePair(); // Perform a visual swap of two cups
                shuffleCount++;      // Increment swap counter

                // Schedule the next shuffle step
                activeTimeoutId = setTimeout(performShuffleStep, shuffleInterval);
            }
            performShuffleStep(); // Start the first shuffle step
        }

        /** Ends the shuffling process and allows the player to guess */
        function endShuffle() {
            console.log("Shuffle ended.");
            shuffling = false;    // No longer shuffling
            canGuess = true;      // Allow guessing now
            message.textContent = '专 住!'; // Prompt player to guess
            addGuessListeners();  // Add click listeners to cups
            cups.forEach(cupEl => cupEl.classList.remove('shuffling')); // Clean up any shuffling class
            activeTimeoutId = null; // Clear timeout ID as shuffle sequence is complete
        }

        /** Performs a single visual swap between two randomly chosen cups */
        function shuffleSinglePair() {
            // Pick two different random cup indices
            let index1 = Math.floor(Math.random() * cups.length);
            let index2 = Math.floor(Math.random() * cups.length);
            while (index1 === index2) { // Ensure indices are different
                index2 = Math.floor(Math.random() * cups.length);
            }
            const cup1 = cups[index1]; // First cup element
            const cup2 = cups[index2]; // Second cup element
            // Get the current slot indices from data attributes
            const slotIndex1 = parseInt(cup1.dataset.slot);
            const slotIndex2 = parseInt(cup2.dataset.slot);

            // Swap visual positions by applying the other cup's slot style
            Object.assign(cup1.style, cupSlots[slotIndex2]);
            Object.assign(cup2.style, cupSlots[slotIndex1]);
            // Update the data attributes to reflect the new slot positions
            cup1.dataset.slot = slotIndex2;
            cup2.dataset.slot = slotIndex1;
        }

        /** Handles the player's guess when a cup is clicked */
        function handleGuess(event) {
            // Ignore clicks if not allowed to guess or if shuffling
            if (!canGuess || shuffling) return;

            canGuess = false;         // Disable further guessing
            removeGuessListeners();   // Remove listeners to prevent multiple guesses
            clearActiveTimeout();     // Clear any pending timeouts
            const chosenCup = event.currentTarget; // The cup that was clicked

            console.log(`Guess: Cup in original slot ${parseInt(chosenCup.dataset.slot)}`);
            chosenCup.classList.add('lifted'); // Lift the chosen cup

            // Check if the chosen cup is the one hiding the gift
            if (chosenCup === giftHolderElement) {
                // --- Correct Guess ---
                // Pick and display a random joke
                const randomJokeIndex = Math.floor(Math.random() * jokes.length);
                const randomJoke = jokes[randomJokeIndex];
                message.innerHTML = ` ! 砖转 ! <br><br>  砖:<br><i>${randomJoke}</i>`;
                jokeFeedbackContainer.style.display = 'flex'; // Show feedback buttons

                // Optional: Lower the cup after a short delay
                // activeTimeoutId = setTimeout(() => {
                //     chosenCup.classList.remove('lifted');
                // }, 1000);
                // Game restart is now handled by feedback buttons

            } else {
                // --- Incorrect Guess ---
                message.textContent = `驻住! 注转...`; // Update message

                // Show splat effect
                splatOverlay.style.display = 'flex'; // Make it visible
                splatOverlay.offsetHeight; // Force browser reflow to ensure transition plays
                splatOverlay.classList.add('visible'); // Add class to trigger fade-in

                // Set timeout to handle events after splat duration
                activeTimeoutId = setTimeout(() => {
                    // Hide splat effect
                    splatOverlay.classList.remove('visible'); // Fade out
                    activeTimeoutId = setTimeout(() => {
                        splatOverlay.style.display = 'none'; // Hide completely after fade
                    }, 300); // Wait for fade out transition

                    // Lower the incorrectly chosen cup
                    chosenCup.classList.remove('lifted');

                    // Short delay before revealing the correct cup
                    activeTimeoutId = setTimeout(() => {
                        // Find the correct cup's current slot
                        const correctSlotIndex = parseInt(giftHolderElement.dataset.slot);
                        // Position the gift element under the correct cup's current position
                        Object.assign(gift.style, cupSlots[correctSlotIndex]);

                        // Lift the ACTUAL correct cup
                        giftHolderElement.classList.add('lifted');
                        // Show the gift under the correct cup
                        gift.style.display = 'flex';
                         setTimeout(() => { // Tiny delay for display change
                            gift.classList.add('visible'); // Fade in gift
                         }, 10);

                        message.textContent = `驻住! 注转. 转 转 .`; // Update message

                        // Allow a new game after showing the correct location
                        activeTimeoutId = setTimeout(() => {
                            startButton.disabled = false; // Re-enable start button
                            message.textContent = '抓 "砖拽" 砖拽 砖.';
                            // Lower the correct cup and hide the gift again
                            giftHolderElement.classList.remove('lifted');
                            gift.classList.remove('visible');
                             activeTimeoutId = setTimeout(() => { // Wait for fade out
                                gift.style.display = 'none';
                             }, 300);
                        }, 2000); // Time to show the correct answer

                    }, 100); // Short delay after lowering wrong cup

                }, splatDuration); // Duration the splat is shown
            }
        }

        /** Adds click/touch event listeners to the cups for guessing */
        function addGuessListeners() {
            cups.forEach(cup => {
                cup.addEventListener('click', handleGuess); // Use 'click' - works for touch too
                cup.style.cursor = 'pointer'; // Change cursor to indicate clickable
            });
        }

        /** Removes click/touch event listeners from the cups */
        function removeGuessListeners() {
             cups.forEach(cup => {
                cup.removeEventListener('click', handleGuess);
                cup.style.cursor = 'default'; // Reset cursor
            });
        }

        /** Handles click on either feedback button (funny/not funny) */
        function handleFeedbackClick() {
            console.log("Feedback received, preparing new round.");
            jokeFeedbackContainer.style.display = 'none'; // Hide feedback buttons
            message.textContent = ''; // Clear the message/joke area

            // Find the lifted cup (the correct one from the previous round) and lower it
            const liftedCup = document.querySelector('.cup.lifted');
            if(liftedCup) {
                liftedCup.classList.remove('lifted');
            }
            // Short delay before starting the next round for smoother transition
            setTimeout(setupNewRound, 150);
        }


        // --- Event Listeners and Initial Setup ---

        // Start button click listener
        startButton.addEventListener('click', setupNewRound);

        // Feedback button click listeners
        funnyButton.addEventListener('click', handleFeedbackClick);
        notFunnyButton.addEventListener('click', handleFeedbackClick);

        // Initial setup when the page loads
        window.addEventListener('load', () => {
             resetCupPositions(); // Set initial cup positions
             message.textContent = '抓 注 "砖拽"  转!'; // Initial message
             startButton.disabled = false; // Enable the start button
        });

    </script>

</body>
</html>
